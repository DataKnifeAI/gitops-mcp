name: Tests

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  validate:
    name: Validate YAML and Kubernetes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Validate YAML files
        run: |
          echo "Validating YAML files..."
          find . -name "*.yaml" -o -name "*.yml" | while read file; do
            echo "Validating $file..."
            python3 -c "import yaml; yaml.safe_load(open('$file'))" && echo "✓ $file is valid" || echo "❌ $file failed validation"
          done

      - name: Validate Kubernetes manifests
        run: |
          echo "Validating Kubernetes manifests..."
          find . -name "*.yaml" -o -name "*.yml" | while read file; do
            if grep -q "kind:" "$file" && grep -q "apiVersion:" "$file"; then
              echo "Validating Kubernetes manifest: $file"
              # Basic validation - check for required fields
              if ! grep -q "kind:" "$file" || ! grep -q "apiVersion:" "$file"; then
                echo "❌ $file missing required Kubernetes fields"
                exit 1
              fi
              echo "✓ $file appears to be valid"
            fi
          done || true

      - name: Check repository structure
        run: |
          echo "Checking repository structure..."
          [ -f "README.md" ] && echo "✓ README.md exists" || echo "⚠️  No README.md"
          [ -f "namespace.yaml" ] && echo "✓ namespace.yaml exists" || echo "⚠️  No namespace.yaml"
          [ -f "fleet.yaml" ] && echo "✓ fleet.yaml exists" || echo "⚠️  No fleet.yaml"
          [ -d "mcp-servers" ] && echo "✓ mcp-servers directory exists" || echo "⚠️  No mcp-servers directory"

  push-to-gitlab:
    name: Push to GitLab
    runs-on: ubuntu-latest
    needs:
      - validate
    if: always() && needs.validate.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Push to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git remote add gitlab https://gitlab.com/dk-raas/dkai/devops/gitops-mcp.git || true
          git config credential.helper '!f() { echo "username=oauth2"; echo "password=${GITLAB_TOKEN}"; }; f'
          git fetch gitlab main || true
          git push gitlab HEAD:main || echo "GitLab push failed"
